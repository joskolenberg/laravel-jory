<?php

namespace JosKolenberg\LaravelJory\Tests;

use JosKolenberg\LaravelJory\Facades\Jory;
use JosKolenberg\LaravelJory\Tests\JoryResources\Unregistered\PersonJoryResourceWithCallables;
use JosKolenberg\LaravelJory\Tests\JoryResources\Unregistered\PersonJoryResourceWithScopes;

class SortTest extends TestCase
{
    /** @test */
    public function it_can_sort_a_query_ascending()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                ],
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                ],
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_sort_a_query_descending()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["-name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                ],
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                ],
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_sort_a_query_descending_2()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["-year_start"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                ],
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                ],
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_sort_a_query_on_multiple_fields_1()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["-year_end","name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                ],
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                ],
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);
    }

    /** @test */
    public function it_can_sort_a_query_on_multiple_fields_2()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["-year_end","-name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                ],
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                ],
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_sort_a_query_on_multiple_fields_3()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["year_end","name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                ],
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                ],
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_sort_a_query_on_multiple_fields_4()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["year_end","-name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                ],
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                ],
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_sort_a_relation()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"srt":["name"],"rlt":{"people":{"srt":["last_name"]}}}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 3,
                    'name' => 'Beatles',
                    'year_start' => 1960,
                    'year_end' => 1970,
                    'people' => [
                        [
                            'id' => 11,
                            'first_name' => 'George',
                            'last_name' => 'Harrison',
                            'date_of_birth' => '1943/02/24',
                            'full_name' => 'George Harrison',
                        ],
                        [
                            'id' => 9,
                            'first_name' => 'John',
                            'last_name' => 'Lennon',
                            'date_of_birth' => '1940/10/09',
                            'full_name' => 'John Lennon',
                        ],
                        [
                            'id' => 10,
                            'first_name' => 'Paul',
                            'last_name' => 'McCartney',
                            'date_of_birth' => '1942/06/18',
                            'full_name' => 'Paul McCartney',
                        ],
                        [
                            'id' => 12,
                            'first_name' => 'Ringo',
                            'last_name' => 'Starr',
                            'date_of_birth' => '1940/07/07',
                            'full_name' => 'Ringo Starr',
                        ],
                    ],
                ],
                [
                    'id' => 4,
                    'name' => 'Jimi Hendrix Experience',
                    'year_start' => 1966,
                    'year_end' => 1970,
                    'people' => [
                        [
                            'id' => 13,
                            'first_name' => 'Jimi',
                            'last_name' => 'Hendrix',
                            'date_of_birth' => '1942/11/27',
                            'full_name' => 'Jimi Hendrix',
                        ],
                        [
                            'id' => 15,
                            'first_name' => 'Mitch',
                            'last_name' => 'Mitchell',
                            'date_of_birth' => '1946/07/09',
                            'full_name' => 'Mitch Mitchell',
                        ],
                        [
                            'id' => 14,
                            'first_name' => 'Noel',
                            'last_name' => 'Redding',
                            'date_of_birth' => '1945/12/25',
                            'full_name' => 'Noel Redding',
                        ],
                    ],
                ],
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                    'people' => [
                        [
                            'id' => 8,
                            'first_name' => 'John',
                            'last_name' => 'Bonham',
                            'date_of_birth' => '1948/05/31',
                            'full_name' => 'John Bonham',
                        ],
                        [
                            'id' => 7,
                            'first_name' => 'John Paul',
                            'last_name' => 'Jones',
                            'date_of_birth' => '1946/01/03',
                            'full_name' => 'John Paul Jones',
                        ],
                        [
                            'id' => 6,
                            'first_name' => 'Jimmy',
                            'last_name' => 'Page',
                            'date_of_birth' => '1944/01/09',
                            'full_name' => 'Jimmy Page',
                        ],
                        [
                            'id' => 5,
                            'first_name' => 'Robert',
                            'last_name' => 'Plant',
                            'date_of_birth' => '1948/08/20',
                            'full_name' => 'Robert Plant',
                        ],
                    ],
                ],
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                    'people' => [
                        [
                            'id' => 1,
                            'first_name' => 'Mick',
                            'last_name' => 'Jagger',
                            'date_of_birth' => '1943/07/26',
                            'full_name' => 'Mick Jagger',
                        ],
                        [
                            'id' => 2,
                            'first_name' => 'Keith',
                            'last_name' => 'Richards',
                            'date_of_birth' => '1943/12/18',
                            'full_name' => 'Keith Richards',
                        ],
                        [
                            'id' => 4,
                            'first_name' => 'Charlie',
                            'last_name' => 'Watts',
                            'date_of_birth' => '1941/06/02',
                            'full_name' => 'Charlie Watts',
                        ],
                        [
                            'id' => 3,
                            'first_name' => 'Ronnie',
                            'last_name' => 'Wood',
                            'date_of_birth' => '1947/06/01',
                            'full_name' => 'Ronnie Wood',
                        ],
                    ],
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(2);
    }

    /** @test */
    public function it_can_combine_relations_filters_and_sorts()
    {
        $response = $this->json('GET', 'jory/band', [
            'jory' => '{"flt":{"f":"name","o":"like","d":"%in%"},"srt":["-name"],"rlt":{"people":{"flt":{"f":"last_name","o":"like","d":"%a%"},"srt":["-last_name"],"fld":["last_name"]}}}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 1,
                    'name' => 'Rolling Stones',
                    'year_start' => 1962,
                    'year_end' => null,
                    'people' => [
                        [
                            'last_name' => 'Watts',
                        ],
                        [
                            'last_name' => 'Richards',
                        ],
                        [
                            'last_name' => 'Jagger',
                        ],
                    ],
                ],
                [
                    'id' => 2,
                    'name' => 'Led Zeppelin',
                    'year_start' => 1968,
                    'year_end' => 1980,
                    'people' => [
                        [
                            'last_name' => 'Plant',
                        ],
                        [
                            'last_name' => 'Page',
                        ],
                        [
                            'last_name' => 'Bonham',
                        ],
                    ],
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(2);
    }

    /** @test */
    public function it_can_apply_a_custom_sort()
    {
        $response = $this->json('GET', 'jory/album', [
            'jory' => '{"srt":["number_of_songs","name"],"fld":["id","name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 4,
                    'name' => 'Led Zeppelin',
                ],
                [
                    'id' => 5,
                    'name' => 'Led Zeppelin II',
                ],
                [
                    'id' => 1,
                    'name' => 'Let it bleed',
                ],
                [
                    'id' => 6,
                    'name' => 'Led Zeppelin III',
                ],
                [
                    'id' => 2,
                    'name' => 'Sticky Fingers',
                ],
                [
                    'id' => 10,
                    'name' => 'Are you experienced',
                ],
                [
                    'id' => 9,
                    'name' => 'Let it be',
                ],
                [
                    'id' => 11,
                    'name' => 'Axis: Bold as love',
                ],
                [
                    'id' => 7,
                    'name' => 'Sgt. Peppers lonely hearts club band',
                ],
                [
                    'id' => 12,
                    'name' => 'Electric ladyland',
                ],
                [
                    'id' => 8,
                    'name' => 'Abbey road',
                ],
                [
                    'id' => 3,
                    'name' => 'Exile on main st.',
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_apply_a_custom_sort_2()
    {
        $response = $this->json('GET', 'jory/album', [
            'jory' => '{"srt":["band_name","number_of_songs"],"fld":["id","name"]}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 9,
                    'name' => 'Let it be',
                ],
                [
                    'id' => 7,
                    'name' => 'Sgt. Peppers lonely hearts club band',
                ],
                [
                    'id' => 8,
                    'name' => 'Abbey road',
                ],
                [
                    'id' => 10,
                    'name' => 'Are you experienced',
                ],
                [
                    'id' => 11,
                    'name' => 'Axis: Bold as love',
                ],
                [
                    'id' => 12,
                    'name' => 'Electric ladyland',
                ],
                [
                    'id' => 4,
                    'name' => 'Led Zeppelin',
                ],
                [
                    'id' => 5,
                    'name' => 'Led Zeppelin II',
                ],
                [
                    'id' => 6,
                    'name' => 'Led Zeppelin III',
                ],
                [
                    'id' => 1,
                    'name' => 'Let it bleed',
                ],
                [
                    'id' => 2,
                    'name' => 'Sticky Fingers',
                ],
                [
                    'id' => 3,
                    'name' => 'Exile on main st.',
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_apply_a_sort_by_a_local_scope_on_the_related_model()
    {
        $response = $this->json('GET', 'jory/album-cover', [
            'jory' => '{"srt":["album_name"],"lmt":4}',
        ]);

        $expected = [
            'data' => [
                [
                    'id' => 8,
                    'album_id' => 8,
                    'image' => '@@@@@@@@@#@@@@@@@@@@@@@@@#@@@@=#=:----------------------------------------+=###
@@@@@@@@@@@@#@@@##@@@@@@@@@@@#=**+:---------------------------------------+###@
@@@@@@@@@@@#@@@@#####@@@@@######+++------------------------------------++*#@@##
@@@@@@@@@@@@@@@#@##@@#===###=*=:*=:---------------------------------:::#@@@##@@
@@@@@@@@@@@@@@######==###@@=*#====*+++**:------------------------+::=*@@#@@#@=#
@@@@@@@@@@@@@@@@@@###@@#@@@####=###===*----------------::--::-::+=:*=+*#@#@@@==
@@@@@@@@@@@@@@####======#@#=#==****+::-------------:+**====#=*=*#=**=*=#==##=#@
@@@@@@@@@@@@@@@@#=#@@@######=#=##+----------------:*=######=#==#==#=@###===#=##
@#@@@@@@@@@@@@@@@@@@@@#@@@@@@@@#=+---------------+=##=##=###=====#@@@@@#@##@@@@
@@@@@@@@@@@@@@@@@@#@@@@#====#@#=##*-------------+=#@#####========@@@@###@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@####@#=+:::-----------*#=#=@#@##=###=#@@@@@@@@@@@@@@@
@@@@@@@@@@@@#@@@@@@@@@@#@@@##=#===*:----------:-++===#######==#@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@#@@@###=#==*:---------:=#@@#@*=#####@@#@@@#@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@##@@####+:------:+*==#@####=#=#@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@####@###=+------+#=#=#@=#@#@*=##@###@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@#@@@@@@@@@@##=##@#=#@#=+----+###==#@@@@@@=@@@##@@@@@@@@@@@@@@@@@@@@
@@@@#*#@@@@@#@@@@@@@@@@@@=#@@###@===*-==###=@##==@@@##@@@@@@###@@##@@@##@@@@@@@
@#@==*#@@@@@@##@@@@@#*=@@#==*@@@##=#==#=######=+++====#@@@@@@@@@@####@#@@@@@@@@
@@@@@@@@@@@@@#@@@#@@@==#@#*+=##*==+++++:***=*****=====#=#@@@@==@**===@=*#=@@###
@@@@@@@@@@@@#@@@@#@####====+***::+**********=*=+****::*@@@@@#@@@#+***#@=##@@@@@
@@@@@@@@@@@##@#===*:-:*###==**=@##***==***==***==###=+*@#@@@@##@@#@@@@@@@#@@@@#
@@@@@@@@@@@@++*::+++:=*+####@@#**========*=======#@@#+*#@=#=#=###***@@@@@@@@@@@
@@@@@@@@@@####**=:-:-:*-####@=:*=##====*=*===#=*:*****=====***=##==*####@@@@@@@
@@@######**=#==#*+**+##@#=====#*=========**==@#:===****++**++**----***++******=
########=**=*=@@@@@@@#=====####=#=======***=@@@@=======******+:----**+*****+***
########=*+*=######======*=#####@#=======*:=@@@@#========****+-----+++=#*+**+++
@########=***###==============##@@========:*@@@@@============+----:**+++++*#=++
==#@##=***=##:+*==*=======##==###@========+#@@@@@===========:-----+********+++*
#==========#@=*===========#@+*#===========@@@@@@@@+========:-:----:==*****+++++
==*====*===*#=============#@@*##==========@@@@@@@=============::---*=**********
==***++*=====#=#:::::::*###@####*-:::-*===#@@*-@@@:--=#===#=+---:--:#=#===*+++*
------*=======*==+:--:####@##==##*---:#==@@@#*--@@=--:#####:-----:---+#======:-
---*#=====#*:++=**+-=######@#++=@##+-*=#@@@###:-+@@@--:##:--:#=--------+##===##
+=#====##+:*+::+==+:+=**=#@*:****##+-=#@@@@@@#+*+=@@#------#@@@@+--------+#####
##=#+::++:------:=####==##+-----:++**#@@@@#===:--+#@##::-*@#####@#+--------+###
####=:---------=###===###+----------=##=======+---------:+===######:--:------+#
#@*-:---::---+#=#=#=####+----------:#######==#*-----------=#===#====+----------
*-::::::---:###==###=##*-----------*#====#=##=#------------#####======:--------
::::::::--=######=####*------------#=#=####=#=#:-----------:######===##+-------
:::::---+@###########+------::----+##=#===#=###:------------:#######=###=------',
                ],
                [
                    'id' => 10,
                    'album_id' => 10,
                    'image' => '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++*==***=*==*==***+++++++++++++++++++++++++++++++
+++++++***+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++====#*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++*===*===+++++++*##=*=*++****##=++++++=+=*+++++++++++++++++++++++++++++++++
++*#########*#=####*#=*####*+*###*==*###**#====*=*+*==*====*=====*=*==*=*==++++
+++++++=###=*#=#*==*##+###*+++*##=#=======#==#*#=*#=#*=#=#======#==*=*==##=*+++
+++++++=####*===#*#*##*###=***###=*=+*=*+*****#*=**==*=***=**==***==*+**==#*+++
+++++++#####=+**=*+*##*##########=++++++++++++++++++++++++++++++++*********++++
++++++*=####*++++++++++=###***###*+++++++++++++++++++++++++++++++********=**+++
+++++#=#*###=++++++++++*##*+++=##++++++++++++++++++++++++++++++++++++++*****+++
+++++=***####=++++++*#=*##**++=##===:::--::+*===**+++++++++++++++++++++++++++++
++++++=#####=+++++++*###==##=*#*###+:--::::+++:+*===*++++++++++++++++++++++++++
+++++++++++++++++++++++*==**+++***+:+:------:::++**++*=*+++++++++++++++++++++++
+++++++++++++++++++++*=+--:*+:+::+--::::----:::-:++++:::**+++++++++++++++++++++
+++++++++++++++++++*=+++*:=++++**++::+:+::---::--:++++:::+=*+++++++++++++++++++
++++++++++++++++++*==+*=***++*+*******+:**++:++*****+:::+++=*++++++++++++++++++
+++++++++++++++++*====*+:+*=*=+++****==#@@@@#=*****++++*++**==+++++++++++++++++
++++++++++++++++*=#*=+***=**:=#@@#**=#@W#=*=@@#=*+====*+++**+**++++++++++++++++
++++++++++++++++==*****===*=@W@WWWW###@W*+=+=@=**##=::#=+:::::=*+++++++++++++++
+++++++++++++++**+=**===###@@+*#@WW@#===###==****#@#=::++:--:-+=+++++++++++++++
+++++++++++++++****===#=#=###+##WW#=*=******==*****=*=+:+-:-:--**++++++++++++++
+++++++++++++++=*====##****#@@@@@#=#***+****++*+**==*==*+-::---**++++++++++++++
+++++++++++++++==#####=****=#*==*****+:::+++*+:*****+=:::-::::+**++++++++++++++
+++++++++++++++*==####******=***==#+*:---:+::-+*:**:+++++::-::*=*++++++++++++++
+++++++++++++++*=#==#=*+=****#=##@#+:----:+:---+:+**+++++:::++*=+++++++++++++++
++++++++++++++++=####=*=****=####@##----:++----:+:+:+:::**:-+:=*+++++++++++++++
++++++++====++++*=###=***+===@@@##=+----::::---++:++**+:+++:*+*++++*==*++++++++
+++++++*==+****++*=@#*=**=#==##==##*:::::::----:+:::=**+*++***++***+*==*+++++++
++++++*=====*==*++*=@+***@=*##=*===*::*+::+:+:-:::+=##==*===*++==*+=**==*++++++
++++*=*+*===*=====++****=*====*=#==+++**::+:+++++++=++::++*****====+*====*+++++
++++==**==========*++*=*====*#=#=##++@=**++*=:::++==++++**+*=*====*=*=+*==*++++
++++*======*===**===*++**=**=##=*=@@#==##=*++:+=*+@=++**++**==*+*=*=*=====*++++
++++*========*====****==*+**=####===*=**####==##===**++**===*==*+==*======+++++
++++++***======*+++**===*=**++***==*=====@#=*****++++*=*=====*===*+*=+***++++++
++++++++++==*==*+*==**+*===*=*=*+**++++++++++++*====*=**=*==+=*=====*++++++++++
++++++++++++**====*=***==*===*=**=*=**=====*===**==*===+**=*++***++++++++++++++
+++++++++++++++++++*====**===*====*=****==*=*=**===*=*=***=++++++++++++++++++++
+++++++++++++++++++++++++++++++++++****=**===*==+++****++++++++++++++++++++++++
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++',
                ],
                [
                    'id' => 11,
                    'album_id' => 11,
                    'image' => '************++++++++++++******+++:::+::----::+::::+******+++++++++*+***********
****************+++++++++++*+++:--:****+++*+**+--:+++++++++++++++**************
***************++***+::::::::--:***++::-::++*++**+--+:::++++++*+***************
++++************++++++++:::-.:***+::+++++++++:+:++*+--:::+**+*++************+++
+++++++++++++++**+++++++++-.+*+*-:++::::::::++++:++++-:+++**++*****+++:++++++++
++++++++++++++::::::::+++:-:*++:+::::--:-::-::++:+:+++-:**++::::+:+++++:+++++++
++++++++++++++++:::::::::--+++::+++:::::::+::::+++:++*---::::::::+++::+++++++++
+++++++++++++++::::::::::--***+++:::-::::-::-:-:++::++:.-:::::::+++++++++++++++
**********+++++++++++++++:-*++-:::::::::::::::+++++++*--++*********************
**********+++++++++++++++:-:*++-++:+:::+::+::++::+:+++.-+**********************
************+++***++::::::--:*::+:+#@@#*===#@@@#*-:+*-.::::::++****************
***********+++++:++++:::::=#@@#*:@+:---+=**-.-:++#*#==#@@+::+:++++++++*********
****+++++++++++++++=@#@#@#:.-:-*#=+:-+...:..*--:+##:...-*##@*=##+:+++++++++++**
+++++++++++++++*=#@+..-+@*-+...::#*:--......:.-:##--..:+@=:..-:@@##@=++++++++++
+++++++++++++@=+++:=::..+**#*:-..-*=+:-.....-+*#:....:#:-...::#:----#++++++++++
+++++++++++:*#+*:.-:+::++*+-.:*#*:--+++=##=*++:--+:+*+++::**::::++==.--:++:***+
++++++++=+..=**##*:+=*++:*=@WWWWWWWWWWWWWWWWWWWW@WWWW@#+++:#+::=+:+#+.-++=*+**=
++:::+:+*.-++::*++:+**++=@@WWWWWWWWWWWWWWWWWWWWWWWWWWWW@=+++**:++*++*:--**+*+++
*+++++::.--+++:++++*+:::*WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW@:::=+:-++:+-:::-:::-::
**+::+++-.-*-+##*==@#---+WWWWWWWWWWWWWWWW@WWWWWWWW@*:-#W#---+--.+=::*+::=*+:*++
**+:+:++*:+*+=**:++*=*::=+=*=WWWWWW@#+-.--:*WWWWW@@=+=*##+*##=:*@#==++:*::---..
*+====#*-+:+:-::+*#**::-:+::*WWWWWWW=#=***#==@WWW@+----+-:+-::+-==*#*::--**:+::
:*:*:=++...-++*==*:+=::*+:+.+W@WWWWW*-+::+.-+@WWW@#-.::==*==-+-+@*+:....+*=:**:
+*:+:=++-..*=*=*:+==*:+--:=-.-#@W@WW@****=:-+=#W@++-..:*==+:**+++:++...:++*:==+
*++@*++++.-*+==:::+:::::+*=*:*..-:++@=*=#*::==+++---*+:+**++:-:=*+:::.:+::+=+*=
*=++**=+++++*==:+++:+*--:*-:+#*=*+.-**=*+*=+**+:*=*=@=-:---+-:+-=#*++::----:=*+
+:::**+-*+=#+=*:++-.-:::**+#:+***=#++=++::+++=*:+#**+:*+:*+:++++++++:+++::+=+==
=:*.*:+.***:*:++++-.-*++*=+:#+*+**=+:+**+++**+:++#=-+:++==*+:+--++:++:+*:+**+@#
*-*.-*-:+=+:=-:+++--*+**++*++*+*+:+**:**++++++++.-+++*:*:*==:*-:*+--*:**:=*:+++
+-:+-:-*****#.-*+*:-*:***:+=:==*+++*+:::+::+::-+.-+-++++:=:+-::=+:--+*+-++++:.-
-++++*+*=+=#=--:+**:--:+*+:=+*===*==*--::*::--::.:=+**++*+*---+*+-:=*+-+*+++..:
.:+++=++#:-*==+-::**-::#*+*+*=#==+**=+::***+++*-.*=***++*-::*+*:-:=+:::+***++-*
:.+++**:=*--***=:-++=*::+++*==*:-:*:+*++:+*-**+.-=*=**:::-**++*::*:-::*+**:+**+
+-.+++#+=*:-:--:*=**+*-++:+*+---:**##*-+:++:+***#===*+*++*----++:=+:*+*+::*+:*+
++-.+-::-+*++*:*+:---:*:-*+++--:##+*#*+*=***=:**#===:-.:*:+::+++:++++:::-++:*+*
+++-.:+=*--:++*=*+=*+:*:-==**+=#==:=@=*=**+***:*#===:..-**+---++-::+:-++**+**+:
++++-.:*=:---:--*=*+:--++:**=*=**=-.-+***+:*++-.:*=*+---+:**:--:+*+=****++:---+
+++++--+#++*=+++****+::-:*+*:***==:.:+*+:**-+*..:#*=*::+:+--+-++:=:-:-----+*::+
++++++-::--:++:+::++*==*-:**=+==+=-.-=::*-:**=-.+*+=**=-+*+:-+*+-+***:*=***::*+
+++++:::***----+-:::+++++*=:***+=+--+:=#:--+*+:*#:++***=-*+*:*:*++---:+:::++:**',
                ],
                [
                    'id' => 12,
                    'album_id' => 12,
                    'image' => '========================###========#===========================================
=======================####=================********===========================
=========================##=================**+*++++****===================*===
===========================#===============**++++++++++++**====================
===============================#=========*+++::+++++********==================#
=======================================*+++::::::::::++**===*===##============#
=====================================**+++++++:::---:++******+**===============
==============####==================****++++++++++::+++**++++++**=============*
==============###==================**+++++++++::++*******++::++**==============
=======================#=========*+++++++++++:::::+++****+++:+***==============
================================*++++++++++::--::::::::++:::::++**=============
===============================**+++++++++:::---::::::::::::::::::+*===========
============================***+++++++++::::-------::::++++++***+:-:+*=======**
======##=========****++*====**+++++++++:::--------::::::++++*====*++**=========
==#===####======*+++++:+*=**+++++++++++::-------::::::::::::++++*==**==========
==##==##====#=====***=******++++++++:::::-----::::::::::++++++++*=============#
======================*****+++++++::::::::-::::::::::::+++::+******===========#
===============***********+++++++::::::::::::::::+::::++****+:+*==*==========##
===============*****+++**++++++++:::::::::::::::::::++*=====*+--****=======####
==============**++++++++*+++++++++++::::::::::::::::::+*=======+**===##########
=============**+++++++++**++++++++++::::::::::::++::::::++**===++**=###########
####========**++++:+++++***+++++++++++::::::::::::::--:::::++*=***==###########
###=======***++++::::::+****=***++++++++::++++::::------::::::***=#############
##===*******+++::::::::+++*********++++++++++++:::-----:+++++****=##===########
@#==**+++++++++::::::::::+++***********++++++++::::::::++********=#############
@@@#=+++++++++:::::::---:+++++************++++++:::::::++**====*=##############
@@@@##*+++++++:::::::::::++++++**************++++:::::+++****===###############
@@@@@##=++++++::::::::::::++++++++*********=*****+++::+*******=################
@@@@@@@##*++++::::::::::::++++++++++**==========************=##################
@@@@@@@@##+++:::::::::::::+++++::::+++*============********=##@################
@@@@@@@@@#=++::::::::::::+++++++++++++*============********#@@#################
@@@@@@@@@@@=+::::::::::::+++++++*******===============*===#@###################
@@@@@@@@@@@#=+::::::::::+++++***=====================#####@####################
@@@@@@@@@@@@#*++::::::::+++**===========##############@###@####################
@@@@WWWWWWW@@=*++:::::++**===========#@@@@###############@@####################
@@WWWWWWWWWWW#*++++++***===========#@@@@@@##########@@##@#############@########
@@WWWWWWWWWWW@=*+*****========**==#@@@@@@@@@###@#@#@#@#@@@@###@#####@##########
@WW@WWWWWWWWWW#*****=**===*****===@@@@@@@@####@@###@@@@#@#@@@@##@#@############
@@@@@@@WWW@@@@@=**==*****+***====@@@@@@@@@@@@#######@###@###@###@##############
@@@@@@@@@@@@@@@=****+++******==#@#@@#@#@@@@@###################################',
                ],
            ],
        ];
        $response->assertStatus(200)->assertExactJson($expected)->assertJson($expected);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_apply_sorting_by_using_a_sort_scope_class()
    {
        $response = $this->json('GET', 'jory/album', [
            'jory' => [
                'srt' => ['-alphabeticName'],
                'fld' => [
                    'name',
                ],
                'lmt' => 4,
            ],
            'case' => 'camel'
        ]);

        $response->assertStatus(200)->assertExactJson([
            'data' => [
                [
                    'name' => 'Sticky Fingers'
                ],
                [
                    'name' => 'Sgt. Peppers lonely hearts club band'
                ],
                [
                    'name' => 'Let it bleed'
                ],
                [
                    'name' => 'Let it be'
                ],
            ],
        ]);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_apply_a_sort_via_the_field_using_a_sort_scope_class()
    {
        Jory::register(PersonJoryResourceWithScopes::class);

        $response = $this->json('GET', 'jory/person', [
            'jory' => [
                'srt' => ['dateOfBirth'],
                'fld' => [
                    'lastName',
                ],
                'lmt' => 3,
            ],
            'case' => 'camel'
        ]);

        $response->assertStatus(200)->assertExactJson([
            'data' => [
                [
                    'lastName' => 'Watts',
                ],
                [
                    'lastName' => 'Harrison',
                ],
                [
                    'lastName' => 'Hendrix',
                ],
            ],
        ]);

        $this->assertQueryCount(1);
    }

    /** @test */
    public function it_can_apply_via_the_field_using_a_filter_scope_class_when_requesting_a_relation()
    {
        Jory::register(PersonJoryResourceWithScopes::class);

        $response = $this->json('GET', 'jory/band/3', [
            'jory' => [
                'fld' => [
                    'name',
                ],
                'rlt' => [
                    'people' => [
                        'fld' => ['lastName'],
                        'srt' => ['-dateOfBirth'],
                    ]
                ]
            ],
            'case' => 'camel'
        ]);

        $response->assertStatus(200)->assertExactJson([
            'data' => [
                'name' => 'Beatles',
                'people' => [
                    [
                        'lastName' => 'Starr',
                    ],
                    [
                        'lastName' => 'McCartney',
                    ],
                    [
                        'lastName' => 'Lennon',
                    ],
                    [
                        'lastName' => 'Harrison',
                    ],
                ]
            ],
        ]);

        $this->assertQueryCount(2);
    }

    /** @test */
    public function it_can_apply_a_sort_using_a_callback()
    {
        Jory::register(PersonJoryResourceWithCallables::class);

        $response = $this->json('GET', 'jory/person', [
            'jory' => [
                'fld' => [
                    'last_name',
                ],
                'flt' => [
                    'f' => 'last_name',
                    'o' => 'like',
                    'd' => '%s',
                ],
                'srt' => 'last_name_alias',
            ],
        ]);

        $response->assertStatus(200)->assertExactJson([
            'data' => [
                ['last_name' => 'Jones'],
                ['last_name' => 'Richards'],
                ['last_name' => 'Watts'],
            ],
        ]);

        $response = $this->json('GET', 'jory/person', [
            'jory' => [
                'fld' => [
                    'last_name',
                ],
                'flt' => [
                    'f' => 'last_name',
                    'o' => 'like',
                    'd' => '%s',
                ],
                'srt' => '-last_name_alias',
            ],
        ]);

        $response->assertStatus(200)->assertExactJson([
            'data' => [
                ['last_name' => 'Watts'],
                ['last_name' => 'Richards'],
                ['last_name' => 'Jones'],
            ],
        ]);
    }

    /** @test */
    public function it_can_apply_a_sort_using_a_callback_via_field_definition()
    {
        Jory::register(PersonJoryResourceWithCallables::class);

        $response = $this->json('GET', 'jory/person', [
            'jory' => [
                'fld' => [
                    'last_name',
                ],
                'flt' => [
                    'f' => 'last_name',
                    'o' => 'like',
                    'd' => '%s',
                ],
                'srt' => 'last_name',
            ],
        ]);

        $response->assertStatus(200)->assertExactJson([
            'data' => [
                ['last_name' => 'Watts'],
                ['last_name' => 'Richards'],
                ['last_name' => 'Jones'],
            ],
        ]);

        $response = $this->json('GET', 'jory/person', [
            'jory' => [
                'fld' => [
                    'last_name',
                ],
                'flt' => [
                    'f' => 'last_name',
                    'o' => 'like',
                    'd' => '%s',
                ],
                'srt' => '-last_name',
            ],
        ]);

        $response->assertStatus(200)->assertExactJson([
            'data' => [
                ['last_name' => 'Jones'],
                ['last_name' => 'Richards'],
                ['last_name' => 'Watts'],
            ],
        ]);
    }
}
